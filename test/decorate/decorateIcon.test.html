<!DOCTYPE html>
<html lang="en">
<body>
<script type="module">
  /* eslint-env mocha */
  import { runTests } from '@web/test-runner-mocha';
  import { expect } from '@esm-bundle/chai';
  import { decorateIcon } from '../../src/decorate.js';
  import { decorateIcons } from '../../src/index.js';

  window.hlx = {};

  runTests(() => {
    beforeEach(() => {
      document.body.querySelectorAll('span').forEach((el) => el.remove());
    });

    it('decorates icons with alt text', async () => {
      window.hlx.codeBasePath = '/test/fixtures';

      const iconA = document.createElement('span');
      iconA.className = 'icon icon-a';
      decorateIcon(iconA, '', 'icon a alt text');

      const iconB = document.createElement('span');
      iconB.className = 'icon icon-b';
      decorateIcon(iconB);

      document.body.prepend(iconA, iconB);

      const icons = document.querySelectorAll('.icon');
      icons.forEach((icon) => {
        expect(icon.firstElementChild.alt).to.exist;
        if (icon === iconA) {
          expect(icon.firstElementChild.alt).to.be.equal('icon a alt text');
        } else if (icon === iconB) {
          expect(icon.firstElementChild.alt).to.be.equal('');
        }
      });
    });

    it('does not process icon if img exists', async () => {
      window.hlx.codeBasePath = '/test/fixtures';
      const iconA = document.createElement('span');
      iconA.className = 'icon icon-a';
      decorateIcon(iconA, '', 'icon a alt text');

      const iconB = document.createElement('span');
      iconB.className = 'icon icon-b';
      decorateIcon(iconB);

      document.body.prepend(iconA, iconB);
      decorateIcons(document.body);

      const icons = document.querySelectorAll('.icon');
      icons.forEach((icon) => {
        const img = icon.querySelectorAll('img');
        expect(img.length).to.be.equal(1);
      });
    });

    it('adds aria-label to parent link', async () => {
      window.hlx.codeBasePath = '/test/fixtures';

      const link = document.createElement('a');
      link.href = '/';
      const icon = document.createElement('span');
      icon.className = 'icon icon-logo';
      link.appendChild(icon);
      document.body.appendChild(link);

      decorateIcon(icon);

      expect(link.getAttribute('aria-label')).to.equal('logo');
      expect(icon.querySelector('img')).to.exist;
    });

    it('does not overwrite existing aria-label on parent link', async () => {
      window.hlx.codeBasePath = '/test/fixtures';

      const link = document.createElement('a');
      link.href = '/';
      link.setAttribute('aria-label', 'Custom Label');
      const icon = document.createElement('span');
      icon.className = 'icon icon-logo';
      link.appendChild(icon);
      document.body.appendChild(link);

      decorateIcon(icon);

      expect(link.getAttribute('aria-label')).to.equal('Custom Label');
    });

    it('does not add aria-label to links with text content', async () => {
      window.hlx.codeBasePath = '/test/fixtures';

      const link = document.createElement('a');
      link.href = '/';
      link.textContent = 'Home ';
      const icon = document.createElement('span');
      icon.className = 'icon icon-arrow';
      link.appendChild(icon);
      document.body.appendChild(link);

      decorateIcon(icon);

      expect(link.getAttribute('aria-label')).to.be.null;
    });
  });
</script>
</body>
</html>
